language: bash

env:
  global:
  - IMAGE_NAME=${DOCKER_USERNAME}/spark
  - HADOOP_MAJMIN_VERSION=2.7
  - JAVA_MAJOR_VERSION=8

matrix:
  include:
  # Debian builds
  - services: docker
    env:
    - SPARK_VERSION=2.4.0
    - DIST=debian
    - LATEST=true
  - services: docker
    env:
    - SPARK_VERSION=2.3.2
    - DIST=debian
  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - DIST=debian
  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - DIST=debian
  - services: docker
    env:
    - SPARK_VERSION=2.0.2
    - DIST=debian
  # Alpine builds
  - services: docker
    env:
    - SPARK_VERSION=2.4.0
    - DIST=alpine
  - services: docker
    env:
    - SPARK_VERSION=2.3.2
    - DIST=alpine
  - services: docker
    env:
    - SPARK_VERSION=2.2.3
    - DIST=alpine
  - services: docker
    env:
    - SPARK_VERSION=2.1.3
    - DIST=alpine
  - services: docker
    env:
    - SPARK_VERSION=2.0.2
    - DIST=alpine
  
before_script:
- docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"

script:
# Docker tags to use (some are omitted since the version values are constant)
- REF_TAG="ref"
- REF_IMAGE="${IMAGE_NAME}:${REF_TAG}"

## Spark only tags
- SPARK_TAG="${SPARK_VERSION}"
- SPARK_MAJMIN_TAG="${SPARK_VERSION:0:3}"

## Spark + Java tags
- JAVA_MAJOR_TAG="java-${JAVA_MAJOR_VERSION}"
- SPARK_JAVA_MAJOR_TAG="${SPARK_TAG}_${JAVA_MAJOR_TAG}"
- SPARK_MAJMIN_JAVA_MAJOR_TAG="${SPARK_MAJMIN_TAG}_${JAVA_MAJOR_TAG}"

## Spark + Java + Dist tags
- DIST_TAG="${DIST}"
- SPARK_JAVA_MAJOR_DIST_TAG="${SPARK_TAG}_${JAVA_MAJOR_TAG}_${DIST_TAG}"
- SPARK_MAJMIN_JAVA_MAJOR_DIST_TAG="${SPARK_MAJMIN_TAG}_${JAVA_MAJOR_TAG}_${DIST_TAG}"

# Docker build
- |-
  docker build . -f Dockerfile-${DIST} \
    --build-arg JAVA_MAJOR_VERSION="${JAVA_MAJOR_VERSION}" \
    --build-arg SPARK_VERSION="${SPARK_VERSION}" \
    --build-arg HADOOP_MAJMIN_VERSION="${HADOOP_MAJMIN_VERSION}" \
    -t "${REF_IMAGE}"

# Docker verification
- |-
  docker run --rm ${REF_IMAGE} \
    spark-submit --version

# Docker re-tagging
# Spark version is always unique across Nomad version, so all builds can tag and push independently
- |-
  if [ "${DIST} = debian" ]; then
    # Non-dist tag is given to Debian
    docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_TAG}"
    docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_MAJMIN_TAG}"
    docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_JAVA_MAJOR_TAG}"
    docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_MAJMIN_JAVA_MAJOR_TAG}"
  fi
- docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_JAVA_MAJOR_DIST_TAG}"
- docker tag "${REF_IMAGE}" "${IMAGE_NAME}:${SPARK_MAJMIN_JAVA_MAJOR_DIST_TAG}"

# Docker push to registry
- |-
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ]; then
    if [ "${DIST} = debian" ]; then
      docker push "${IMAGE_NAME}:${SPARK_TAG}"
      docker push "${IMAGE_NAME}:${SPARK_MAJMIN_TAG}"
      docker push "${IMAGE_NAME}:${SPARK_JAVA_MAJOR_TAG}"
      docker push "${IMAGE_NAME}:${SPARK_MAJMIN_JAVA_MAJOR_TAG}"
    fi

    docker push "${IMAGE_NAME}:${SPARK_JAVA_MAJOR_DIST_TAG}"
    docker push "${IMAGE_NAME}:${SPARK_MAJMIN_JAVA_MAJOR_DIST_TAG}"
  fi

branches:
  only:
  - master
